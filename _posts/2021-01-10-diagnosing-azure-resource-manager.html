---
layout: post
title: Diagnosing Azure Resource Manager template validation errors
date: '2021-01-10T17:12:00.002+01:00'
author: Stefan Szarek
tags:
- Azure
- cloud
modified_time: '2021-01-10T17:14:20.832+01:00'
thumbnail: https://1.bp.blogspot.com/-lZjM0UYPigA/X_Yvs9lj90I/AAAAAAAAArw/QfZYVrPBReszi3idLo4evlZ7BdzMxrFLACLcBGAsYHQ/s72-w640-c-h54/2021-01-06%2B22_45_57-posh%257Egit%2B%257E%2Bprovisioning-with-azure-resource-manager%2B%255Bmain%255D%2B%2528Admin%2529.png
blogger_id: tag:blogger.com,1999:blog-1400779654511127347.post-790995191235074817
blogger_orig_url: https://sszarek.blogspot.com/2021/01/diagnosing-azure-resource-manager.html
---

<div style="text-align: left;">In <a href="https://sszarek.blogspot.com/2021/01/provisioning-with-azure-resource.html">previous post</a> I have provided intro to Azure Resource templates. While performing deployment of the template you might run into situation where Azure is returning quite a cryptic message similar to one one the screenshot below.<div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-lZjM0UYPigA/X_Yvs9lj90I/AAAAAAAAArw/QfZYVrPBReszi3idLo4evlZ7BdzMxrFLACLcBGAsYHQ/s1920/2021-01-06%2B22_45_57-posh%257Egit%2B%257E%2Bprovisioning-with-azure-resource-manager%2B%255Bmain%255D%2B%2528Admin%2529.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="163" data-original-width="1920" height="54" src="https://1.bp.blogspot.com/-lZjM0UYPigA/X_Yvs9lj90I/AAAAAAAAArw/QfZYVrPBReszi3idLo4evlZ7BdzMxrFLACLcBGAsYHQ/w640-h54/2021-01-06%2B22_45_57-posh%257Egit%2B%257E%2Bprovisioning-with-azure-resource-manager%2B%255Bmain%255D%2B%2528Admin%2529.png" width="640" /></a></div>From the error you will get few pieces of information:<br /><ul style="text-align: left;"><li>Name of the template: <i>azuredeploy</i></li><li>Template has failed validation procedure</li><li>You can check details with provided tracking Id which is some Guid</li></ul>Details we are looking for can be found in Activity Log of Resource Group to which deployment was done and there are few ways we can get it. Activity Log is a place where actions related to resources are logged (in this case we will be looking for logs on Resource Group level) e.g.:<ul style="text-align: left;"><li>Deletion of resources</li><li>Deployments</li><li>Starting and stopping of resources</li></ul></div><div>The logs include such information as:</div><div><ul style="text-align: left;"><li>Timestamp</li><li>Principal which initiated event</li><li>JSON object which describes change in details</li></ul></div><h3 style="text-align: left;">Break something!</h3><div>To show you sample error like one on the screenshot above we will break something to trigger validation error. We will use code from the previous post which is located in <a href="https://github.com/sszarek/provisioning-with-azure-resource-manager">GitHub repository</a>.</div><p style="text-align: left;">Clone the repository and open&nbsp;<i>azuredeploy.parameters.json</i> file. To break it change value of the <i>storageAccountName</i> parameter to&nbsp;<i>provision-warm-template</i>. Now you can try to deploy the template with the instruction from the previous post or the GitHub repository - as a result you should get error similar to one on the screenshot above.</p><h3 style="text-align: left;">Using Azure Portal</h3><div>In Azure Portal you can view Activity Log for deployment on Resource Group level by navigating to the group where you tried to deploy resources and choosing Activity Log blade.</div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-CITdAF3TPCc/X_eDDGq7dtI/AAAAAAAAAsQ/jree1ckRSPcbWwh9n1zCe2NC7aRNj7OxQCLcBGAsYHQ/s1889/2021-01-07%2B22_44_46-my-infra-rg%2B-%2BMicrosoft%2BAzure%2Band%2B2%2Bmore%2Bpages%2B-%2BWork%2B-%2BMicrosoft%25E2%2580%258B%2BEdge.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="614" data-original-width="1889" height="208" src="https://1.bp.blogspot.com/-CITdAF3TPCc/X_eDDGq7dtI/AAAAAAAAAsQ/jree1ckRSPcbWwh9n1zCe2NC7aRNj7OxQCLcBGAsYHQ/w640-h208/2021-01-07%2B22_44_46-my-infra-rg%2B-%2BMicrosoft%2BAzure%2Band%2B2%2Bmore%2Bpages%2B-%2BWork%2B-%2BMicrosoft%25E2%2580%258B%2BEdge.png" width="640" /></a></div><br /><div>You should see list of recent activities on the Resource Group, including our failed deployment which is marked with red icon and <i>Failed</i> status. After clicking on the failed deployment record you should see panel with details as on screenshot below.</div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-79B3TbOB28Q/X_eOtatZKnI/AAAAAAAAAsc/TwjlG4_NNfIX1n0vH668GPkuhxPlLvIfgCLcBGAsYHQ/s1068/2021-01-07%2B23_31_00-Validate%2BDeployment%2B-%2BMicrosoft%2BAzure%2Band%2B3%2Bmore%2Bpages%2B-%2BWork%2B-%2BMicrosoft%25E2%2580%258B%2BEdge.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="552" data-original-width="1068" height="330" src="https://1.bp.blogspot.com/-79B3TbOB28Q/X_eOtatZKnI/AAAAAAAAAsc/TwjlG4_NNfIX1n0vH668GPkuhxPlLvIfgCLcBGAsYHQ/w640-h330/2021-01-07%2B23_31_00-Validate%2BDeployment%2B-%2BMicrosoft%2BAzure%2Band%2B3%2Bmore%2Bpages%2B-%2BWork%2B-%2BMicrosoft%25E2%2580%258B%2BEdge.png" width="640" /></a></div><br /><div>On the <i>Summary</i> tab you will find pretty much the same information as in the console. The interesting part can be found in <i>JSON</i> tab - here you will find JSON object with the details of the deployment request, the piece of information we are looking for is contained in <i>properties.statusMessage</i> property. Here you will find stringified JSON object, similar to one in the snippet.</div><div><pre><code>{\"error\":{\"code\":\"InvalidTemplateDeployment\",\"message\":\"The template deployment 'azuredeploy' is not valid according to the validation procedure. The tracking id is '0fa3c66c-6b01-4f42-aadf-0a886c926d35'. See inner errors for details.\",\"details\":[{\"code\":\"PreflightValidationCheckFailed\",\"message\":\"Preflight validation failed. Please refer to the details for the specific errors.\",\"details\":[{\"code\":\"AccountNameInvalid\",\"target\":\"provision-warm-template\",\"message\":\"provision-warm-template is not a valid storage account name. Storage account name must be between 3 and 24 characters in length and use numbers and lower-case letters only.\"}]}]}}</code></pre></div><div style="text-align: left;">In this case we can find information about actual reason of failure at the end of this longish string - long story short, name of the Storage Account does not pass the validation.</div><h3 style="text-align: left;">Using Azure CLI</h3><div>We can get same data with Azure CLI just by providing tracking Id from the error.</div><div><pre><code>az monitor activity-log list --correlation-id 0fa3c66c-6b01-4f42-aadf-0a886c926d35</code></pre></div><div style="text-align: left;">Instead of Guid provided as an value for <i>correlation-id</i>&nbsp;parameter, provide tracking id value from the error. Running the command will result with JSON object which includes error details in <i>properties.statusMessage</i>. You probably noticed that output JSON is verbose and does include lots of not related information which obfuscates things. It would be great to be able to extract only relevant information. Thankfully Azure CLI has <i>query</i> argument which allows to extract only the information we are interested in from the output of the command. Lets see how it works and run following command:</div><div style="text-align: left;"><pre><code class="bash">az monitor activity-log list `<br />    --correlation-id 0fa3c66c-6b01-4f42-aadf-0a886c926d35 `<br />    --query "[?level=='Error'].properties.{Entity: entity, StatusCode: statusCode, StatusMessage: statusMessage}" `<br />    --output yaml</code></pre></div><div style="text-align: left;">The output of the command should be look like that:</div><div style="text-align: left;"><pre><code class="yaml">- Entity: /subscriptions/975874d0-9f27-4c97-8464-701c68575c6b/resourcegroups/my-infra-rg/providers/Microsoft.Resources/deployments/azuredeploy<br />  StatusCode: BadRequest<br />  StatusMessage: '{"error":{"code":"InvalidTemplateDeployment","message":"The template<br />    deployment ''azuredeploy'' is not valid according to the validation procedure.<br />    The tracking id is ''0fa3c66c-6b01-4f42-aadf-0a886c926d35''. See inner errors<br />    for details.","details":[{"code":"PreflightValidationCheckFailed","message":"Preflight<br />    validation failed. Please refer to the details for the specific errors.","details":[{"code":"AccountNameInvalid","target":"provision-warm-template","message":"provision-warm-template<br />    is not a valid storage account name. Storage account name must be between 3 and<br />    24 characters in length and use numbers and lower-case letters only."}]}]}}'</code></pre></div><div style="text-align: left;">As you can see it is much easier to understand what is actual problem with deployment just by looking at <i>StatusMessage</i> property of resulting YAML. Lets dissect the command and see how it works.</div><p style="text-align: left;"><b><i>az monitor activity-log</i></b>&nbsp;- first piece of command is responsible for selecting Azure resource type against which command will be run. In this case we would like to ingest activity logs which are part of Azure Monitor - thus we use <i>monitor activity-log</i>. For other types of resources you can use other parameter names e.g. <i>account</i> for subscription or <i>group</i> for resource groups.</p><p style="text-align: left;"><i><b>list</b></i> - tells Azure to get... list (surprise :) of all resources of specific type (defined in the first piece of command) executing principal has access to.</p><p style="text-align: left;"><i><b>--correlation-id &lt;Guid&gt;</b></i> - this is one of <a href="https://docs.microsoft.com/en-us/cli/azure/monitor/activity-log?view=azure-cli-latest#az_monitor_activity_log_list-optional-parameters">optional parameters</a> for <i>az monitor activity-log list</i>, which is responsible for getting only these activity log records which are assigned to specific correlation Id.</p><p style="text-align: left;"><i><b>--query &lt;JMESPath Query&gt;</b></i> - this is the most interesting part of the command. It accepts so called <a href="https://jmespath.org/">JMESPath query</a> which allows to filter out result and select only the fields we are interested in.<br />Lets take a closer look at the query we have used in example above:</p><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-JeZyb5hqItk/X_sSGMcQruI/AAAAAAAAAso/sxZFaMT8yyobc-XLKN214Zn1bqdaM3qrwCLcBGAsYHQ/s781/JMESPathQuery.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="101" data-original-width="781" height="82" src="https://1.bp.blogspot.com/-JeZyb5hqItk/X_sSGMcQruI/AAAAAAAAAso/sxZFaMT8yyobc-XLKN214Zn1bqdaM3qrwCLcBGAsYHQ/w640-h82/JMESPathQuery.png" width="640" /></a></div><div class="separator" style="clear: both; text-align: left;">First note that for Azure CLI JMESPath queries have to be provided in double quotes - it is quite important to remember about that, in some cases you will not get any syntax error but instead of that results my be ambiguous.</div><div class="separator" style="clear: both; text-align: left;">I have split above query into three pieces: filter, path and field selectors:</div><div class="separator" style="clear: both; text-align: left;"><ul style="text-align: left;"><li>Filter - [?level='Error'] - the first piece is surrounded with square braces which mean that we are dealing with JSON array. Inside of braces with have expression starting with question mark - it is responsible for filtering out object which do not meet the condition - <i>level</i> property of the object must be equal to <i>Error</i>. To sum up, the filter expression here will go through array of objects and filter out these object where <i>level</i> property has value other than <i>Error</i>.</li><li>Path - this part of query string tells that only <i>properties</i> property of the object should be returned.</li><li>Field Selectors - at the end in curly braces there are field selectors, they are responsible for selecting the fields to be returned. Imagine object with ten properties, out of which you are interested in two (similar as in our case), with this syntax you are able to tell Azure to return only selected set of fields and give each of them alias name. For each field the syntax is following: <i>&lt;alias&gt;: &lt;name of the field in original object&gt;</i>.</li></ul><p style="text-align: left;"><i><b>--output yaml</b></i> - the last parameter is responsible for defining the output format of the data to by YAML. As you probably noticed by default Azure CLI is outputting the data in JSON format. Other commonly used value for this parameter is <i>table</i>. Full list of possible values can be found in&nbsp;<a href="https://docs.microsoft.com/pl-pl/cli/azure/format-output-azure-cli">https://docs.microsoft.com/pl-pl/cli/azure/format-output-azure-cli</a>.&nbsp;</p></div><div style="text-align: left;">With that knowledge you should be able to build simple yet powerful queries for filtering out data returned by Azure CLI as the&nbsp;<i>--query</i>&nbsp;parameter is available for all the commands. No go and experiment with query syntax :)</div><h3 style="text-align: left;">More reading</h3><div><a href="https://docs.microsoft.com/en-us/cli/azure/monitor/activity-log?view=azure-cli-latest#az_monitor_activity_log_list-optional-parameters">Documentation for az monitor activity-log list</a></div><div><a href="https://jmespath.org/">JMESPath Official Page</a></div>
---
layout: post
title: Provisioning Azure resources with Terraform - Part 1 - Basics
date: '2021-02-13T19:13:00.002+01:00'
author: Stefan Szarek
tags:
- Azure
- IaC
- cloud
- Terraform
modified_time: '2021-02-20T17:51:38.253+01:00'
thumbnail: https://1.bp.blogspot.com/-Omaa4kg9sxU/YBxvmuP6dQI/AAAAAAAAAtE/0Ve-Zz9ySsou5C_S3fyRRQ7vbumOCOpNgCLcBGAsYHQ/s72-w640-c-h368/2021-02-04%2B23_03_52-posh%257Egit%2B%257E%2Bprovisioning-azure-with-terraform%2B%255Bmain%255D%2B%2528Admin%2529.png
blogger_id: tag:blogger.com,1999:blog-1400779654511127347.post-8572190712405745045
blogger_orig_url: https://sszarek.blogspot.com/2021/02/provisioning-azure-resources-with.html
---

<h2 style="text-align: left;">Intro</h2><div>Terraform is one of the popular <a href="https://en.wikipedia.org/wiki/Infrastructure_as_code">Infrastructure as Code</a> (IaC) tools. There are simple yet powerful ideas behind the tool:</div><div><ul style="text-align: left;"><li>It uses configuration files to describe infrastructure. The configuration is written in declarative language called HCL (Hashicorp Configuration Language).</li><li>Thanks to rich Terraform Registry it supports dozens of providers - this obviously includes Azure along with GCP and AWS.</li><li>In order to create resources in proper order it creates dependency graph between them.</li><li>When deploying infrastructure changes it is saving state of the infrastructure. With this approach in case of change in infrastructure it is able to use the state to calculate which resources have changed and update only those.</li></ul><div>This article starts short series which will lead you through basics of provisioning Azure resources with Terraform by building infrastructure for running serverless application with Azure Functions.</div></div><p style="text-align: left;">As a prerequisite you will need to execute following steps:</p><p style="text-align: left;"></p><ul style="text-align: left;"><li>Download Terraform. You can do that using official download site:&nbsp;<a href="https://www.terraform.io/downloads.html">https://www.terraform.io/downloads.html</a> or Chocolatey (in case you are using this great tool):&nbsp;https://chocolatey.org/packages/terraform.&nbsp;</li><li>Make sure that you have Azure CLI installed and default subscription is set up. If you don't know how to do that refer to my <a href="https://sszarek.blogspot.com/2021/01/provisioning-with-azure-resource.html">older post about Azure Resource Manager</a> which describes required steps.</li></ul><p></p><h2 style="text-align: left;">Configuring provider</h2><p style="text-align: left;">Code for this section is available in GitHub repository:&nbsp;<a href="https://github.com/sszarek/provisioning-azure-with-terraform/tree/1-create-resource-group">https://github.com/sszarek/provisioning-azure-with-terraform/tree/1-create-resource-group</a>, under <i>1-create-resource-group</i> tag.</p><div>The first thing we will need is provider - provider is plugin which extends Terraform with capabilities of e.g. supporting specific cloud provider. Every provider deliver some set of <i>resource</i>&nbsp;types which can be used when writing Terraform configuration. For example, we will be using Azure provider which extend extends Terraform with such resources as storage account, resource groups or Cosmos DB (and much more - full list available in article linked at the end).</div><p style="text-align: left;">Lets start from creating&nbsp;<i>main.tf</i>&nbsp;file and adding following content:</p><pre><code>terraform {<br />  required_providers {<br />    azurerm = {<br />      source  = "hashicorp/azurerm"<br />      version = "&gt;= 2.26"<br />    }<br />  }<br />}</code></pre><p>Code above declares <i>terraform</i> block which is used for setting Terraform configuration. Examples of such configuration are:</p><p></p><ul style="text-align: left;"><li>required providers -&nbsp;<i>required_providers</i> block - defines list of providers and their versions required for running the script.</li><li>required Terraform version - <i>required_version</i> block - defines version constraints for Terraform CLI required for running the script.</li><li>backend - <i>backend</i> block - configures backend used for storing Terraform state file. I will touch this topic later in this article.</li></ul><div>In the code above we are telling Terraform that the script depends on <i>azurerm</i> provider:<br /><ul style="text-align: left;"><li><i>source</i> argument defines Terraform registry URL where provider can be located. The format used in the code above consists of namespace (<i>hashicorp</i>) and type (<i>azurerm</i>) which will be used to locate provider in official Terraform registry located in:&nbsp;<a href="https://registry.terraform.io/">https://registry.terraform.io/</a>. Terraform also allows to use other registries (e.g. company private registry) - in such scenario full URL to provider has to be provided.</li><li><i>version</i> argument defines that the script requires at least version 2.26 of the module.</li></ul><div><a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest">hashicorp/azurerm</a> provider is official provider for Azure cloud maintained by Hashicorp, creator of Terraform. When working on Terraform scripts it is worth to keep documentation for the provider close at hand - to e.g. find list of arguments for resources or learn about some configuration edge cases. For Azure provider documentation can be found here:&nbsp;<a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs">https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs</a>.</div></div><p style="text-align: left;">Now that we have defined dependency on Azure provider we need to add one more important block.</p><pre><code>provider "azurerm" {<br />  features { }<br />}</code></pre><p><i>provider</i> block contains configuration of the provider and it is required. <i>features</i> argument is required for Azure provider - it customizes behavior of some Azure resources. Since we do not want to customize anything here, we leave it blank. Full list of arguments available for configuring Azure provider can be found in <a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs#argument-reference">documentation</a>.</p><h2 style="text-align: left;">Adding first resource</h2><div>We are ready now to add our first resource block. Resource blocks are defined in following way:</div><div><pre><code>resource "&lt;resource type&gt;" "&lt;local name&gt;" {<br />  argument1 = "foo"<br />  argument2 = "bar"<br />}</code></pre></div><p style="text-align: left;">As seen on snippet above, when creating creating a resource we need to provide:</p><p style="text-align: left;"></p><ul style="text-align: left;"><li>Type (<i>&lt;resource type&gt;</i> label) of resource. This refers to resource types defined by providers e.g. Azure provider.</li><li>Local name (<i>&lt;local name&gt;</i> label) which allows to refer to resource within the scope of Terraform script. This should not be confused with the name of "physically" created resource in the cloud.</li><li>Resource configuration arguments.</li></ul><p></p><p style="text-align: left;">It should not be surprise that the first resource we will create is Resource Group. Add code below to <i>main.tf</i> file.</p><div><pre><code>resource "azurerm_resource_group" "rg" {<br />  name     = "terraform_example_app"<br />  location = "centralus"<br />}</code></pre></div><p style="text-align: left;">The code above creates Azure Resource Group in Central US region with name <i>terraform_example_app</i>. Inside script it will referenced as <i>rg</i>.</p><p style="text-align: left;">Now that we have provider configured and first resource defined it is time to deploy that stuff to Azure!</p><h2 style="text-align: left;">First deployment</h2><div>The first thing we need to do is to call&nbsp;<i>terraform init</i> command which is responsible for:</div><div><ul style="text-align: left;"><li>Downloading providers required by the script - since the providers are not built in they have to be downloaded from registry to local directory. The directory will be created in same location where you run the command and will be called <i>.terraform</i>.</li><li>Creating (or update) lock file (<i>.terraform.lock.hcl</i>). The purpose of the lock file is to freeze concrete versions of dependencies - thanks to that you will always get the same version of providers no matter if you will be running from your local machine or some automated deployment.</li><li>Initializing backends - this topic will be covered in one of the following articles in the series.</li></ul><div>When initialization is finished it is time for reviewing changes which Terraform is going to apply. For this purpose we will run <i>terraform plan</i>. The command will verify what changes it will need to make in current infrastructure and will output them to console. After running the command you should see output similar to one on screenshot below.</div></div><p style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-Omaa4kg9sxU/YBxvmuP6dQI/AAAAAAAAAtE/0Ve-Zz9ySsou5C_S3fyRRQ7vbumOCOpNgCLcBGAsYHQ/s976/2021-02-04%2B23_03_52-posh%257Egit%2B%257E%2Bprovisioning-azure-with-terraform%2B%255Bmain%255D%2B%2528Admin%2529.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="562" data-original-width="976" height="368" src="https://1.bp.blogspot.com/-Omaa4kg9sxU/YBxvmuP6dQI/AAAAAAAAAtE/0Ve-Zz9ySsou5C_S3fyRRQ7vbumOCOpNgCLcBGAsYHQ/w640-h368/2021-02-04%2B23_03_52-posh%257Egit%2B%257E%2Bprovisioning-azure-with-terraform%2B%255Bmain%255D%2B%2528Admin%2529.png" width="640" /></a></p>As you can see, the output is very descriptive: all the resources (well.. the single resource which is <i>azurerm_resource_group</i>) which are going to be created are marked with green plus sign.&nbsp;<br /><p style="text-align: left;">We are now finally ready to apply changes - this is done with <i>terraform apply</i> command. In its first phase it will display output similar to one from <i>plan</i> command, letting you review changes one more time. After confirming, Terraform will start creating resources and after it completes you will be able to see newly created Resource Group available in Azure Portal.</p><h2 style="text-align: left;">State file</h2><p style="text-align: left;">If you look closer you will notice that after running <i>terraform apply</i> there was new file created - it is <i>terraform.tfstate</i>. The file contains JSON representation of the current state of infrastructure managed by Terraform. It maps resources defined in scripts (identified by resource type and local name) with "physical" resources in the cloud (identified by resource id assigned by cloud provider). Below you will find state file similar to one on your machine - red rectangles mark script local and physical resource identifiers.</p><div class="separator" style="clear: both; text-align: center;"><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-EU9Axy4OCKY/YCBb7LAGwYI/AAAAAAAAAtc/rkgSWnJKa0cbLV4UznNccpCyCwE19qC_QCLcBGAsYHQ/s811/TerraformStateMapping.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="691" data-original-width="811" height="546" src="https://1.bp.blogspot.com/-EU9Axy4OCKY/YCBb7LAGwYI/AAAAAAAAAtc/rkgSWnJKa0cbLV4UznNccpCyCwE19qC_QCLcBGAsYHQ/w640-h546/TerraformStateMapping.png" width="640" /></a></div></div><p style="text-align: left;">Further in this article we will modify already created scripts and add other resources. When we will be deploying that changes Terraform will use information from <i>terraform.tfstate</i> in order to build execution plan and determine which resources will be modified, deleted or added.</p><p style="text-align: left;">You should avoid manual editing of the file as it might yield undesired results.</p><h2 style="text-align: left;">Variables</h2><p style="text-align: left;">Code for this section is available in GitHub repository under <i>2-parametrize-with-variables</i> tag:&nbsp;<a href="https://github.com/sszarek/provisioning-azure-with-terraform/tree/2-parametrize-with-variables">https://github.com/sszarek/provisioning-azure-with-terraform/tree/2-parametrize-with-variables</a>.</p><div style="text-align: left;">Imagine that you would like to re-use script we have just created to provision Resource Group in different region. This seems to be as easy as changing value of location argument for <i>rg</i> resource however there is better way of doing that.</div><p style="text-align: left;">Terraform comes with the support of variables which allow you to parametrize your scripts. Lets create new <i>variables.tf</i> file.</p><p style="text-align: left;"></p><pre><code>variable "location" {<br />    default = "centralus"<br />    description = "Azure region where resources will be provisioned"<br />    type = string<br />}</code></pre><p>Block above defines <i>location</i> variable. There are three arguments set here:</p><p></p><ul style="text-align: left;"><li><i>type</i> - defines type of the variable. Here we are using <i>string</i> type. Full list of types can be found in documentation:&nbsp;<a href="https://www.terraform.io/docs/language/values/variables.html#type-constraints">https://www.terraform.io/docs/language/values/variables.html#type-constraints</a>&nbsp;</li><li><i>description</i> - provides information for other developers or users of the script on the purpose of the variable.</li><li><i>default</i> - sets value for variable in case it is not explicitly set.</li></ul><div>Now lets get back to <i>main.tf</i> and replace hardcoded value for <i>location</i> argument with variable. We will replace: <i>"centralus"</i> with <i>var.location</i>, updated resource block looks on the snippet below:</div><div><pre><code>resource "azurerm_resource_group" "rg" {<br />  name     = "terraform_example_app"<br />  location = var.location<br />}</code></pre></div><p></p><div style="text-align: left;">If you run terraform plan after this refactoring, you should see nice green message: <i>"No changes. Infrastructure is up-to-date"</i>. This should be no surprise, after all we have not changed any resources but only did some refactoring.</div><p style="text-align: left;">When I was starting this section I was talking about case when we would like to deploy resources to different region than <i>Central US</i> which is currently used and set as default value for variable. To do so we need to explicitly set its value. We can do that in two ways.</p><h4 style="text-align: left;">Setting value as argument for CLI</h4><div>First approach is to set variable value when calling <i>terraform plan/apply</i>&nbsp;commands. To provide value for variable when running one of the commands you will need to use <i>-var</i> argument, which has following format: <i>-var="&lt;variable name&gt;=&lt;variable value&gt;"</i>. Lets check it in action by setting <i>location</i> variable to East US for <i>terraform plan</i>.</div><div><pre><code>terraform plan -var="location=eastus"</code></pre></div><p style="text-align: left;">Screenshot below presents output similar to one you should see on your machine.</p><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-Jb13dPty5c4/YCMGCLNvMiI/AAAAAAAAAto/egwRELJ42OsqnPB9bdUVaurCm_eaViViQCLcBGAsYHQ/s1700/2021-02-09%2B22_50_41-posh%257Egit%2B%257E%2Bprovisioning-azure-with-terraform%2B%255Bmain%255D%2B%2528Admin%2529.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="631" data-original-width="1700" height="238" src="https://1.bp.blogspot.com/-Jb13dPty5c4/YCMGCLNvMiI/AAAAAAAAAto/egwRELJ42OsqnPB9bdUVaurCm_eaViViQCLcBGAsYHQ/w640-h238/2021-02-09%2B22_50_41-posh%257Egit%2B%257E%2Bprovisioning-azure-with-terraform%2B%255Bmain%255D%2B%2528Admin%2529.png" width="640" /></a></div><br /><p style="text-align: left;">Since we have provided new region for our Resource Group it needs to be recreated: resource in Central US will be destroyed and new one will be created in East US. It is also worth to take a look at the <i>location</i> argument on the output above: there is information in red next to it saying: <i>"forces replacement"</i>&nbsp;- when working on more complicated scripts you might run into situation where Terraform will be trying to replace some resource and this information is priceless for determining the reason of this.</p><h4 style="text-align: left;">Using tfvars file</h4><div>Another way of providing values for variables is through <i>*.tfvars</i> file. This approach is convenient when you would like to group value for different environments. Lets create <i>development.tfvars</i> file and put following code there:&nbsp;</div><div><pre><code>location = "eastus"</code></pre></div><p style="text-align: left;">Now that the file is created we will run <i>terraform plan</i> with <i>-var-file</i> argument which accepts path to <i>tfvar</i> file.</p><p style="text-align: left;"></p><pre><code>terraform plan -var-file="development.tfvars"</code></pre><p></p><p style="text-align: left;">The result of calling the command should be the same as in previous case when we were providing variable value with <i>-var</i> command line argument.</p><h2 style="text-align: left;">Applying with variables</h2><div>In previous section I was using <i>plan</i> command to present capabilities of variables, however this command is not making any changes to infrastructure. To make things happen we must use <i>apply</i>. The command accepts variable values in the same way as its done for plan:</div><div><ul style="text-align: left;"><li>Using <i>-var</i> command line argument where you provide values directly in command line.</li><li>Using <i>-var-file</i> command line argument where you provide name of file which contains values for variables used in scripts.</li></ul></div><h2 style="text-align: left;">Cleaning up</h2><div>Since we are getting to the end of this article it is good idea to clean up, previously created Azure resources. It should be no surprise that Terraform has separate command to handle this as well. The command is <i>terraform destroy</i>&nbsp;- it deletes all the resources which are tracked in <i>terraform.tfstate</i>.</div><h2 style="text-align: left;">Links</h2><div style="text-align: left;"><a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs">https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs</a> - Documentation for Azure provider&nbsp;</div>